#!/bin/bash

PARENT_DIR="$(dirname "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)")"
source $PARENT_DIR/parameters

rm -rf $DISTRO/data
rm -rf $DISTRO/etc/opendaylight/current
rm -rf $DISTRO/cache
rm -rf $DISTRO/journal
rm -rf $DISTRO/snapshots
rm -rf $DISTRO/instances

source $DISTRO/bin/setenv
export KARAF_OPTS=-Dorg.apache.sshd.registerBouncyCastle=false
$DISTRO/bin/start

while true;
do
	up=$(netstat -an | grep 127.0.0.1:1830 | wc -l)
	if [ $up == 2 ]
	then
		printf ">"
		break
	else
		echo "ODL is starting"
		sleep 5
	fi 
done

while true;
do
	ready=$(curl http://${ODL_USER}:${ODL_PASS}@localhost:8181/restconf/operational/network-topology:network-topology/ 2>&1)
	if echo $ready | grep -q "connected";
	then
		echo "ODL is ready!"
		exit 0
	else
		echo ">>"
		sleep 5
	fi
done

